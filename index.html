<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acil Servis Nöbet Planlama</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @media print {
            @page { size: landscape; margin: 5mm; }
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .overflow-x-auto { overflow: visible !important; }
            table { width: 100%; font-size: 9px !important; }
            th, td { border: 1px solid #000 !important; padding: 2px !important; color: black !important; }
            .bg-blue-200 { background-color: #bfdbfe !important; }
            .bg-orange-200 { background-color: #fed7aa !important; }
            .bg-green-200 { background-color: #bbf7d0 !important; }
            .bg-red-100 { background-color: #fee2e2 !important; }
            .bg-yellow-50 { background-color: #fefce8 !important; }
            .print-hidden { display: none; }
        }
        .sticky-col { position: sticky; left: 0; z-index: 20; background-color: white; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #999; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; font-family: sans-serif; color: #666;">
            Uygulama Yükleniyor...
        </div>
    </div>

    <script type="text/babel">
        // --- GÜVENLİ ICON SETİ (Çökme Riskini Önler) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Calendar: (p) => <IconBase {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></IconBase>,
            Printer: (p) => <IconBase {...p}><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></IconBase>,
            Trash2: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></IconBase>,
            Plus: (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>,
            FileSpreadsheet: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></IconBase>,
            ChevronLeft: (p) => <IconBase {...p}><polyline points="15 18 9 12 15 6"></polyline></IconBase>,
            ChevronRight: (p) => <IconBase {...p}><polyline points="9 18 15 12 9 6"></polyline></IconBase>,
            X: (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>,
            Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></IconBase>,
            Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"></polyline></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconBase>,
            Menu: (p) => <IconBase {...p}><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="18" x2="20" y2="18"></line></IconBase>,
            Image: (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></IconBase>,
            Info: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></IconBase>,
            Edit2: (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconBase>
        };

        const { useState, useEffect, useRef } = React;

        // --- BAŞLANGIÇ VERİLERİ ---
        const INITIAL_STAFF = [
            { id: 1, name: "ABDURRAHMAN ŞAHİN", group: "A" }, { id: 2, name: "AHMET ALTINTAŞ", group: "A" },
            { id: 3, name: "AHMET KAYA", group: "A" }, { id: 4, name: "ALEYNA NUR ÇELİK", group: "A" },
            { id: 5, name: "ALİ İHSAN ÖZDEMİR", group: "A" }, { id: 6, name: "ARZU BOZBOĞA", group: "A" },
            { id: 7, name: "ASENA ALBAYRAK", group: "A" }, { id: 8, name: "AYŞE ÇETİN", group: "A" },
            { id: 9, name: "AYŞE SAN", group: "A" }, { id: 10, name: "BURAKHAN KARAKAN", group: "A" },
            { id: 11, name: "BÜŞRA DEŞAT", group: "A" }, { id: 12, name: "BÜŞRA KESKİN", group: "A" },
            { id: 13, name: "CANER KARAMAN", group: "A" }, { id: 14, name: "CEREN CAN EMRE", group: "A" },
            { id: 15, name: "CUMALİ ORUÇ", group: "A" }, { id: 16, name: "DÖNDÜ KARACA KOÇ", group: "A" },
            { id: 17, name: "EBRU TEKTAŞ", group: "A" }, { id: 18, name: "EBUBEKİR BOZKURT", group: "A" },
            { id: 19, name: "ERDİ ŞEN", group: "A" }, { id: 20, name: "ESRA KESKİN", group: "A" },
            { id: 21, name: "FATİH KÖYLÜ", group: "A" }, { id: 22, name: "FUAT ÇOBAN", group: "A" },
            { id: 23, name: "GİZEM TÜRKER", group: "A" }, { id: 24, name: "GONCA METİN", group: "A" },
            { id: 25, name: "GÖKHAN AKGÜL", group: "A" }, { id: 26, name: "HACER AKYÜREK", group: "A" },
            { id: 27, name: "HATİCE EREN", group: "A" }, { id: 28, name: "HİLAL KORUYAN", group: "A" },
            { id: 29, name: "İFAKET DUMLU", group: "A" }, { id: 30, name: "KADİR KAYA", group: "A" },
            { id: 31, name: "KADRIYE ÖZKAN", group: "A" }, { id: 32, name: "MERVE NUR DEMİRTAŞ", group: "A" },
            { id: 33, name: "MUHAMMED TATLI", group: "A" }, { id: 34, name: "OKTAY KARAHAN", group: "A" },
            { id: 35, name: "ÖZGE KUŞ", group: "A" }, { id: 36, name: "RABİA KAHRİMAN", group: "A" },
            { id: 37, name: "RABİA YAVAŞ KAYA", group: "A" }, { id: 38, name: "RAMAZAN BİLGİN", group: "A" },
            { id: 39, name: "RECAİ KARAHAN", group: "A" }, { id: 40, name: "REMZİYE YALMAN", group: "A" },
            { id: 41, name: "REMZİYE YATBAZ", group: "A" }, { id: 42, name: "SELMA SERTELLİ", group: "A" },
            { id: 43, name: "SEMİHA ADIYAMAN", group: "A" }, { id: 44, name: "SERHAT DURAK", group: "A" },
            { id: 45, name: "ŞAFAK TAŞTAN", group: "A" }, { id: 46, name: "ŞAZİMET AYTEKİN", group: "A" },
            { id: 47, name: "ERDİ GÜREL", group: "A" }, { id: 48, name: "TUĞBA DENİZ GÜREL", group: "A" },
            { id: 49, name: "VURAL GÜLEÇ", group: "A" }, { id: 50, name: "YARENGÜZEL AŞÇI", group: "A" },
            { id: 51, name: "YASEMİN ERDEM", group: "A" }, { id: 52, name: "YASİN KİRAZ", group: "A" },
            { id: 53, name: "YUNUS EMRE YILDIZ", group: "A" }, { id: 54, name: "ZEHRA TEKBIÇAK", group: "A" },
            { id: 64, name: "YENİ PERSONEL EKLE", group: "A" }, 
            // GRUP B
            { id: 55, name: "PINAR İLÇİN", group: "B" }, { id: 56, name: "ÖZLEM BOZKURT", group: "B" },
            { id: 57, name: "NURCAN ÇİFTÇİ", group: "B" }, { id: 58, name: "MERVE POYRAZ", group: "B" },
            { id: 59, name: "CANSU ÖZEN", group: "B" }, { id: 60, name: "BURCU KIYAK", group: "B" },
            { id: 61, name: "FATMA KIRTAŞ", group: "B" }, { id: 62, name: "HÜLYA ŞAHİN", group: "B" },
            { id: 63, name: "SÜMEYYE KARAKAYA", group: "B" },
        ];

        const DUTY_SLOTS = [
            { id: 'sari_1', label: 'Sarı 1', type: '24' }, { id: 'sari_2', label: 'Sarı 2', type: '24' },
            { id: 'sari_3', label: 'Sarı 3', type: '24' }, { id: 'sari_4', label: 'Sarı 4', type: '24' },
            { id: 'kadin_1', label: 'Kadın 1', type: '24' }, { id: 'kadin_2', label: 'Kadın 2', type: '24' }, { id: 'kadin_3', label: 'Kadın 3', type: '24' },
            { id: 'erkek_1', label: 'Erkek 1', type: '24' }, { id: 'erkek_2', label: 'Erkek 2', type: '24' }, { id: 'erkek_3', label: 'Erkek 3', type: '24' },
            { id: 'triaj_24_1', label: 'Triaj 24-1', type: '24' }, { id: 'triaj_24_2', label: 'Triaj 24-2', type: '24' },
            { id: 'yesil_24_1', label: 'Yeşil 24-1', type: '24' }, { id: 'yesil_24_2', label: 'Yeşil 24-2', type: '24' },
            { id: 'triaj_16', label: 'Triaj 16', type: '16' }, { id: 'yesil_16', label: 'Yeşil 16', type: '16' },
            { id: 'triaj_8', label: 'Triaj 8', type: '8' }, { id: 'yesil_8', label: 'Yeşil 8', type: '8' },
        ];

        const MONTHS = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];

        // --- PERSONEL YÖNETİMİ BİLEŞENİ ---
        const StaffManager = ({ staffList, setStaffList, showNotification }) => {
            const [newName, setNewName] = useState("");
            const [newGroup, setNewGroup] = useState("A");
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState("");
            const [editGroup, setEditGroup] = useState("");

            const addStaff = () => {
                if(!newName) return;
                const maxId = staffList.length > 0 ? Math.max(...staffList.map(s => s.id)) : 0;
                setStaffList([...staffList, { id: maxId + 1, name: newName.toUpperCase(), group: newGroup }]);
                setNewName("");
                showNotification("Personel eklendi.", "success");
            }

            const deleteStaff = (id) => {
                if (deleteConfirmId === id) {
                    setStaffList(staffList.filter(s => s.id !== id));
                    setDeleteConfirmId(null);
                    showNotification("Personel silindi.", "success");
                } else {
                    setDeleteConfirmId(id);
                    setTimeout(() => setDeleteConfirmId(null), 3000);
                }
            }

            const startEditing = (staff) => {
                setEditingId(staff.id);
                setEditName(staff.name);
                setEditGroup(staff.group);
            }

            const saveEditing = () => {
                setStaffList(staffList.map(s => s.id === editingId ? { ...s, name: editName.toUpperCase(), group: editGroup } : s));
                setEditingId(null);
                showNotification("Personel güncellendi.", "success");
            }

            return (
                <div className="bg-white p-4 rounded-lg shadow-lg border border-gray-200">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-teal-800">
                        <Icons.Users size={24} /> Personel Yönetimi
                    </h2>
                    
                    <div className="flex flex-col sm:flex-row gap-2 mb-4 bg-gray-50 p-3 rounded">
                        <input type="text" placeholder="AD SOYAD GİRİNİZ" className="border p-2 rounded flex-1 uppercase w-full outline-none focus:ring-2 focus:ring-teal-500" value={newName} onChange={(e) => setNewName(e.target.value)} />
                        <select className="border p-2 rounded w-full sm:w-auto outline-none" value={newGroup} onChange={(e) => setNewGroup(e.target.value)}>
                            <option value="A">Grup A</option>
                            <option value="B">Grup B</option>
                        </select>
                        <button onClick={addStaff} className="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700 font-bold w-full sm:w-auto flex items-center justify-center gap-1">
                            <Icons.Plus size={18} /> EKLE
                        </button>
                    </div>

                    <div className="max-h-[60vh] overflow-y-auto border rounded">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th className="p-3 text-left">İsim</th>
                                    <th className="p-3 text-center">Grup</th>
                                    <th className="p-3 text-right">İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                {staffList.map((staff) => (
                                    <tr key={staff.id} className="border-t hover:bg-teal-50">
                                        <td className="p-2">
                                            {editingId === staff.id ? (
                                                <input type="text" className="border p-1 rounded w-full uppercase" value={editName} onChange={e=>setEditName(e.target.value)} />
                                            ) : staff.name}
                                        </td>
                                        <td className="p-2 text-center">
                                            {editingId === staff.id ? (
                                                <select className="border p-1 rounded" value={editGroup} onChange={e=>setEditGroup(e.target.value)}>
                                                    <option value="A">A</option><option value="B">B</option>
                                                </select>
                                            ) : <span className={`px-2 py-1 rounded text-xs font-bold ${staff.group === 'A' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}`}>{staff.group}</span>}
                                        </td>
                                        <td className="p-2 text-right flex justify-end gap-2">
                                            {editingId === staff.id ? (
                                                <button onClick={saveEditing} className="text-green-600 hover:bg-green-100 p-1 rounded"><Icons.Save size={16}/></button>
                                            ) : (
                                                <button onClick={() => startEditing(staff)} className="text-blue-600 hover:bg-blue-100 p-1 rounded"><Icons.Edit2 size={16}/></button>
                                            )}
                                            <button onClick={() => deleteStaff(staff.id)} className={`p-1 rounded text-xs font-bold transition-all flex items-center gap-1 ${deleteConfirmId === staff.id ? 'bg-red-600 text-white px-2' : 'text-red-500 hover:bg-red-100'}`}>
                                                {deleteConfirmId === staff.id ? 'ONAY' : <Icons.Trash2 size={16}/>}
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )
        }

        // --- ANA UYGULAMA ---
        function App() {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [staffList, setStaffList] = useState(INITIAL_STAFF);
            const [assignments, setAssignments] = useState({});
            const [selectedDay, setSelectedDay] = useState(null);
            const [viewMode, setViewMode] = useState('matrix');
            const [notification, setNotification] = useState(null);
            const [showAutoFillConfirm, setShowAutoFillConfirm] = useState(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const matrixRef = useRef(null);

            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 4000);
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                return Array.from({ length: days }, (_, i) => i + 1);
            };

            const formatDateKey = (year, month, day) => {
                return `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            };

            const calculateStats = () => {
                const stats = {};
                staffList.forEach(s => stats[s.id] = { cgms: 0, tcs: 0, s16: 0, s8: 0, cts: 0, pzr: 0, hs: 0 });
                const prefix = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), 1).substring(0, 7);

                Object.keys(assignments).forEach(dateKey => {
                    if (dateKey.startsWith(prefix)) {
                        const [y, m, d] = dateKey.split('-').map(Number);
                        const dayOfWeek = new Date(y, m - 1, d).getDay(); 
                        const dayAssignments = assignments[dateKey];
                        Object.keys(dayAssignments).forEach(slotId => {
                            const staffId = dayAssignments[slotId];
                            const slotDef = DUTY_SLOTS.find(s => s.id === slotId);
                            if (staffId && stats[staffId] && slotDef) {
                                const duration = parseInt(slotDef.type);
                                stats[staffId].cgms += 1;
                                stats[staffId].tcs += duration;
                                if (duration === 16) stats[staffId].s16 += 1;
                                if (duration === 8) stats[staffId].s8 += 1;
                                if (dayOfWeek === 6) { stats[staffId].cts += 1; stats[staffId].hs += 1; }
                                if (dayOfWeek === 0) { stats[staffId].pzr += 1; stats[staffId].hs += 1; }
                            }
                        });
                    }
                });
                return stats;
            };
            const stats = calculateStats();

            const handleAssignment = (slotId, staffId) => {
                const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);
                setAssignments(prev => {
                    const dayData = prev[dateKey] || {};
                    if (Object.values(dayData).includes(staffId) && dayData[slotId] != staffId && staffId !== "") {
                        showNotification("Bu personel zaten görevli!", "error");
                        return prev;
                    }
                    const updatedDayData = { ...dayData, [slotId]: staffId };
                    if (!staffId) delete updatedDayData[slotId];
                    return { ...prev, [dateKey]: updatedDayData };
                });
            };

            const autoFillMonth = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const days = getDaysInMonth(currentDate);
                const newAssignments = { ...assignments };
                const prefix = formatDateKey(year, month, 1).substring(0, 7);
                Object.keys(newAssignments).forEach(k => { if(k.startsWith(prefix)) delete newAssignments[k]; });
                
                const tempStats = {};
                staffList.forEach(s => tempStats[s.id] = 0);

                days.forEach(day => {
                    const dateKey = formatDateKey(year, month, day);
                    const dayAssignments = {};
                    const usedStaffIds = new Set();
                    DUTY_SLOTS.forEach(slot => {
                        let candidates = [];
                        if (slot.type === '24') candidates = staffList.filter(s => s.group === 'A' && !usedStaffIds.has(s.id));
                        else candidates = staffList.filter(s => !usedStaffIds.has(s.id));
                        
                        if (candidates.length > 0) {
                            candidates.sort((a, b) => tempStats[a.id] - tempStats[b.id]);
                            const chosen = candidates[Math.floor(Math.random() * Math.min(5, candidates.length))];
                            dayAssignments[slot.id] = chosen.id;
                            usedStaffIds.add(chosen.id);
                            tempStats[chosen.id] += 1;
                        }
                    });
                    newAssignments[dateKey] = dayAssignments;
                });
                setAssignments(newAssignments);
                setShowAutoFillConfirm(false);
                showNotification("Dağıtım tamamlandı.", "success");
            };

            const autoFillDay = () => {
                if (!selectedDay) return;
                const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);
                const currentDayAssignments = { ...assignments[dateKey] } || {};
                const usedStaffIds = new Set(Object.values(currentDayAssignments).map(id => parseInt(id)));
                const availableA = staffList.filter(s => s.group === 'A' && !usedStaffIds.has(s.id));
                const availableB = staffList.filter(s => s.group === 'B' && !usedStaffIds.has(s.id));
                const poolA = [...availableA].sort(() => Math.random() - 0.5);
                const poolB = [...availableB].sort(() => Math.random() - 0.5);
                const newAssigns = { ...currentDayAssignments };

                DUTY_SLOTS.forEach(slot => {
                    if (!newAssigns[slot.id]) {
                        let candidate = null;
                        if (slot.type === '24') { if (poolA.length > 0) candidate = poolA.pop(); }
                        else { if (poolB.length > 0) candidate = poolB.pop(); else if (poolA.length > 0) candidate = poolA.pop(); }
                        if (candidate) newAssigns[slot.id] = candidate.id;
                    }
                });
                setAssignments(prev => ({ ...prev, [dateKey]: newAssigns }));
            };

            const clearDay = () => {
                const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);
                const newAssigns = { ...assignments };
                delete newAssigns[dateKey];
                setAssignments(newAssigns);
            }

            const downloadAsJpg = async () => {
                showNotification("5x Kalite JPG hazırlanıyor...", "info");
                if(!matrixRef.current) return;
                
                const element = matrixRef.current;
                const originalOverflow = element.style.overflow;
                const originalHeight = element.style.height;
                element.style.overflow = 'visible';
                element.style.height = 'auto';
                element.style.width = 'fit-content';
                element.style.minWidth = '100%';

                try {
                    const canvas = await html2canvas(element, { 
                        scale: 5, 
                        useCORS: true,
                        windowWidth: element.scrollWidth + 100,
                        windowHeight: element.scrollHeight + 100,
                        backgroundColor: '#ffffff',
                        logging: false
                    });
                    const image = canvas.toDataURL("image/jpeg", 0.95);
                    const link = document.createElement("a");
                    link.href = image;
                    link.download = `Nobet_Listesi_${MONTHS[currentDate.getMonth()]}_${currentDate.getFullYear()}.jpg`;
                    link.click();
                    showNotification("JPG İndirildi.", "success");
                } catch(e) {
                    showNotification("Hata oluştu.", "error");
                    console.error(e);
                } finally {
                    element.style.overflow = originalOverflow;
                    element.style.height = originalHeight;
                    element.style.width = 'auto';
                    element.style.minWidth = 'auto';
                }
            };

            return (
                <div className="pb-20">
                    {notification && <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-[60] px-6 py-3 rounded-full shadow-2xl text-white font-bold flex items-center gap-2 animate-bounce ${notification.type==='error'?'bg-red-600':'bg-teal-600'}`}>{notification.type==='error'?<Icons.AlertTriangle size={20}/>:<Icons.Check size={20}/>}{notification.message}</div>}
                    
                    {showAutoFillConfirm && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4 no-print">
                            <div className="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full border-t-4 border-purple-600">
                                <h3 className="text-xl font-bold mb-2 flex items-center gap-2"><Icons.Sparkles className="text-purple-600"/> Otomatik Dağıt?</h3>
                                <p className="text-gray-600 mb-6 font-medium">Mevcut ayın tüm verileri silinip yeniden dağıtılacak.</p>
                                <div className="flex justify-end gap-3">
                                    <button onClick={()=>setShowAutoFillConfirm(false)} className="px-4 py-2 bg-gray-200 rounded font-bold hover:bg-gray-300">İptal</button>
                                    <button onClick={autoFillMonth} className="px-6 py-2 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 shadow">Onayla</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="bg-gradient-to-r from-teal-700 to-teal-900 text-white p-4 shadow-lg sticky top-0 z-40 no-print">
                        <div className="container mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-white/10 p-2 rounded"><Icons.Calendar size={24} /></div>
                                <div><h1 className="font-black text-xl tracking-tight">ACİL NÖBET</h1></div>
                            </div>
                            <div className="hidden md:flex gap-3">
                                <button onClick={()=>setViewMode('calendar')} className={`px-4 py-2 rounded-lg font-bold transition-all ${viewMode==='calendar'?'bg-white text-teal-900 shadow':'hover:bg-teal-600 text-teal-50'}`}>Takvim</button>
                                <button onClick={()=>setViewMode('matrix')} className={`px-4 py-2 rounded-lg font-bold transition-all ${viewMode==='matrix'?'bg-white text-teal-900 shadow':'hover:bg-teal-600 text-teal-50'}`}>Çizelge</button>
                                <button onClick={()=>setViewMode('staff')} className={`px-4 py-2 rounded-lg font-bold transition-all ${viewMode==='staff'?'bg-white text-teal-900 shadow':'hover:bg-teal-600 text-teal-50'}`}>Personel</button>
                            </div>
                            <button className="md:hidden p-2" onClick={()=>setIsMobileMenuOpen(!isMobileMenuOpen)}>{isMobileMenuOpen ? <Icons.X/> : <Icons.Menu/>}</button>
                        </div>
                        {isMobileMenuOpen && (
                            <div className="flex flex-col gap-2 mt-4 md:hidden pb-2 border-t border-teal-600 pt-2">
                                <button onClick={()=>{setViewMode('calendar');setIsMobileMenuOpen(false)}} className="p-3 bg-teal-800 rounded font-bold text-left">Takvim</button>
                                <button onClick={()=>{setViewMode('matrix');setIsMobileMenuOpen(false)}} className="p-3 bg-teal-800 rounded font-bold text-left">Çizelge</button>
                                <button onClick={()=>{setViewMode('staff');setIsMobileMenuOpen(false)}} className="p-3 bg-teal-800 rounded font-bold text-left">Personel</button>
                            </div>
                        )}
                    </header>

                    <main className="container mx-auto p-2 md:p-6">
                        <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-center gap-4 no-print">
                            <div className="flex items-center gap-4 bg-gray-50 p-2 rounded-full border">
                                <button onClick={()=>{const d=new Date(currentDate);d.setMonth(d.getMonth()-1);setCurrentDate(d)}} className="p-1 hover:bg-gray-200 rounded-full"><Icons.ChevronLeft/></button>
                                <span className="font-bold w-32 text-center text-gray-700">{MONTHS[currentDate.getMonth()]} {currentDate.getFullYear()}</span>
                                <button onClick={()=>{const d=new Date(currentDate);d.setMonth(d.getMonth()+1);setCurrentDate(d)}} className="p-1 hover:bg-gray-200 rounded-full"><Icons.ChevronRight/></button>
                            </div>
                            {viewMode==='matrix' && (
                                <div className="flex flex-wrap gap-2 justify-center w-full md:w-auto">
                                    <button onClick={()=>setShowAutoFillConfirm(true)} className="px-4 py-2.5 bg-purple-600 text-white rounded font-bold shadow hover:bg-purple-700 flex items-center gap-2"><Icons.Sparkles size={18}/> OTO PLANLA</button>
                                    <button onClick={downloadAsJpg} className="px-4 py-2.5 bg-blue-600 text-white rounded font-bold shadow hover:bg-blue-700 flex items-center gap-2"><Icons.Image size={18}/> JPG İNDİR</button>
                                    <button onClick={()=>window.print()} className="px-4 py-2.5 bg-red-600 text-white rounded font-bold shadow hover:bg-red-700 flex items-center gap-2"><Icons.FileText size={18}/> PDF / YAZDIR</button>
                                </div>
                            )}
                        </div>

                        {viewMode === 'staff' && <StaffManager staffList={staffList} setStaffList={setStaffList} showNotification={showNotification} />}
                        
                        {viewMode === 'calendar' && (
                            <div className="grid grid-cols-2 md:grid-cols-7 gap-2">
                                {getDaysInMonth(currentDate).map(d => {
                                    const key = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), d);
                                    const count = Object.keys(assignments[key] || {}).length;
                                    const isWknd = [0,6].includes(new Date(currentDate.getFullYear(), currentDate.getMonth(), d-1).getDay());
                                    return (
                                        <div key={d} onClick={()=>setSelectedDay(d)} className={`h-28 border-2 rounded-xl p-3 cursor-pointer bg-white hover:shadow-lg relative transition-all group ${isWknd?'border-red-200 bg-red-50/30':''}`}>
                                            <span className={`text-xl font-bold ${isWknd?'text-red-500':'text-gray-700'}`}>{d}</span>
                                            {count>0 && <span className={`absolute top-3 right-3 text-xs px-2 py-1 rounded-full font-bold shadow-sm ${count===18?'bg-green-500 text-white':'bg-orange-100 text-orange-600'}`}>{count}/18</span>}
                                            {count===0 && <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-30 transition-opacity"><Icons.Plus size={32} className="text-teal-600"/></div>}
                                        </div>
                                    )
                                })}
                            </div>
                        )}

                        {viewMode === 'matrix' && (
                            <div className="bg-white shadow-xl rounded-lg p-4 overflow-x-auto print-container" ref={matrixRef}>
                                <div className="text-center mb-6 border-b pb-4">
                                    <h1 className="text-2xl font-black text-gray-900 tracking-wide">ERİŞKİN ACİL NÖBET ÇİZELGESİ</h1>
                                    <h2 className="text-lg font-bold text-gray-600 uppercase">{MONTHS[currentDate.getMonth()]} {currentDate.getFullYear()}</h2>
                                </div>
                                <table className="w-full border-collapse text-[10px]">
                                    <thead>
                                        <tr>
                                            <th className="border p-1 bg-gray-100 sticky-col min-w-[150px] text-left z-20 shadow-sm border-gray-400">PERSONEL</th>
                                            {getDaysInMonth(currentDate).map(d => {
                                                const day = new Date(currentDate.getFullYear(), currentDate.getMonth(), d-1).getDay();
                                                const isWknd = day===0 || day===6;
                                                return (
                                                    <th key={d} className={`border border-gray-400 p-0.5 text-center min-w-[24px] ${isWknd?'bg-red-100 text-red-700':'bg-gray-50'}`}>
                                                        <div className="font-bold text-sm">{d}</div>
                                                        <div className="text-[9px] font-normal">{['Pz','Pt','Sa','Ça','Pe','Cu','Ct'][new Date(currentDate.getFullYear(), currentDate.getMonth(), d).getDay()]}</div>
                                                    </th>
                                                )
                                            })}
                                            <th className="border border-gray-400 bg-gray-100 w-8" title="ÇGMS">ÇGMS</th>
                                            <th className="border border-gray-400 bg-yellow-100 w-8" title="TÇS">TÇS</th>
                                            <th className="border border-gray-400 w-6">16</th><th className="border border-gray-400 w-6">8</th>
                                            <th className="border border-gray-400 w-6">Cts</th><th className="border border-gray-400 w-6">Pzr</th>
                                            <th className="border border-gray-400 bg-red-100 w-6">HS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {staffList.sort((a,b)=>a.name.localeCompare(b.name)).map((s, i) => {
                                            const st = stats[s.id];
                                            return (
                                                <tr key={s.id} className={i%2===0?'bg-white':'bg-gray-50 hover:bg-yellow-50'}>
                                                    <td className="border border-gray-400 p-1 pl-2 font-bold sticky-col bg-inherit truncate text-xs z-10">{s.name} {s.group==='B' && <span className="text-[9px] text-purple-600 ml-1">(B)</span>}</td>
                                                    {getDaysInMonth(currentDate).map(d => {
                                                        const key = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), d);
                                                        const slotId = Object.keys(assignments[key]||{}).find(k=>assignments[key][k]==s.id);
                                                        const slot = slotId ? DUTY_SLOTS.find(x=>x.id===slotId) : null;
                                                        let cls = "";
                                                        if(slot) cls = slot.type==='24' ? 'bg-blue-200 text-blue-900 font-bold border-blue-400 print:bg-blue-200' : slot.type==='16' ? 'bg-orange-200 text-orange-900 font-bold border-orange-400 print:bg-orange-200' : 'bg-green-200 text-green-900 font-bold border-green-400 print:bg-green-200';
                                                        return <td key={d} className={`border border-gray-400 text-center p-0 ${cls}`}>{slot ? slot.type : ''}</td>
                                                    })}
                                                    <td className="border border-gray-400 text-center text-gray-700">{st.cgms}</td>
                                                    <td className="border border-gray-400 text-center font-bold bg-yellow-50">{st.tcs}</td>
                                                    <td className="border border-gray-400 text-center text-gray-500">{st.s16}</td>
                                                    <td className="border border-gray-400 text-center text-gray-500">{st.s8}</td>
                                                    <td className="border border-gray-400 text-center text-gray-500">{st.cts}</td>
                                                    <td className="border border-gray-400 text-center text-gray-500">{st.pzr}</td>
                                                    <td className="border border-gray-400 text-center font-bold text-red-600 bg-red-50">{st.hs}</td>
                                                </tr>
                                            )
                                        })}
                                    </tbody>
                                </table>
                                
                                <div className="mt-6 flex flex-wrap gap-4 text-[10px] md:text-xs justify-between print:mt-4">
                                    <div className="border border-gray-400 p-2 rounded min-w-[200px] bg-white">
                                        <h4 className="font-bold border-b border-gray-300 mb-1 flex items-center gap-1"><Icons.Info size={12}/> KISALTMALAR</h4>
                                        <div className="grid grid-cols-2 gap-x-2">
                                            <span>ÇGMS: Nöbet Sayısı</span><span>TÇS: Toplam Saat</span>
                                            <span>HS: Haftasonu</span><span>16/8: Kısa Nöbet</span>
                                        </div>
                                    </div>
                                    <div className="border border-gray-400 p-2 rounded min-w-[150px] bg-white">
                                        <h4 className="font-bold border-b border-gray-300 mb-1">RENK KODLARI</h4>
                                        <div className="flex flex-col gap-1">
                                            <div className="flex gap-2 items-center"><span className="w-3 h-3 bg-blue-200 border border-black block"></span> 24 Saat</div>
                                            <div className="flex gap-2 items-center"><span className="w-3 h-3 bg-orange-200 border border-black block"></span> 16 Saat</div>
                                            <div className="flex gap-2 items-center"><span className="w-3 h-3 bg-green-200 border border-black block"></span> 8 Saat</div>
                                        </div>
                                    </div>
                                    <div className="border border-gray-400 p-2 rounded min-w-[250px] flex flex-col justify-between bg-white">
                                        <h4 className="font-bold border-b border-gray-300 mb-1">ONAY</h4>
                                        <div className="flex justify-between px-2 pt-4">
                                            <div className="text-center"><p>Acil Sorumlusu</p><p className="mt-4 border-b border-black w-20 mx-auto"></p></div>
                                            <div className="text-center"><p>Başhekim</p><p className="mt-4 border-b border-black w-20 mx-auto"></p></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {selectedDay && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 no-print">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col border border-gray-300">
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center rounded-t-xl">
                                    <h2 className="font-bold text-xl text-gray-800">{selectedDay} {MONTHS[currentDate.getMonth()]}</h2>
                                    <button onClick={()=>setSelectedDay(null)} className="p-1 hover:bg-gray-200 rounded-full"><Icons.X/></button>
                                </div>
                                <div className="p-4 overflow-y-auto flex-1 grid grid-cols-1 md:grid-cols-3 gap-3 bg-gray-100">
                                    {DUTY_SLOTS.map(slot => (
                                        <div key={slot.id} className={`p-3 bg-white border rounded-lg shadow-sm flex flex-col gap-2 ${slot.type==='24'?'border-blue-200':slot.type==='16'?'border-orange-200':'border-green-200'}`}>
                                            <div className="flex justify-between font-bold text-xs text-gray-700">
                                                <span>{slot.label}</span>
                                                <span className={`px-2 py-0.5 rounded-full text-white ${slot.type==='24'?'bg-blue-600':slot.type==='16'?'bg-orange-500':'bg-green-600'}`}>{slot.type} Saat</span>
                                            </div>
                                            <select className="w-full text-sm border p-2 rounded focus:ring-2 focus:ring-teal-500 outline-none" 
                                                value={assignments[formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDay)]?.[slot.id]||""}
                                                onChange={(e)=>handleAssignment(slot.id, e.target.value)}
                                            >
                                                <option value="">-- SEÇ --</option>
                                                {staffList.filter(s=>slot.type==='24'?s.group==='A':true).sort((a,b)=>a.name.localeCompare(b.name)).map(s=>(
                                                    <option key={s.id} value={s.id}>{s.name} ({stats[s.id].tcs}s)</option>
                                                ))}
                                            </select>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-3 border-t bg-gray-50 flex justify-between rounded-b-xl">
                                    <button onClick={clearDay} className="text-red-600 font-bold flex items-center gap-1 hover:bg-red-50 px-3 py-1 rounded"><Icons.Trash2 size={18}/> TEMİZLE</button>
                                    <button onClick={()=>{
                                        const k = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);
                                        const dayData = {...(assignments[k]||{})};
                                        const busy = new Set(Object.values(dayData).map(v=>parseInt(v)));
                                        const poolA = staffList.filter(s=>s.group==='A' && !busy.has(s.id)).sort(()=>Math.random()-0.5);
                                        const poolB = staffList.filter(s=>s.group==='B' && !busy.has(s.id)).sort(()=>Math.random()-0.5);
                                        DUTY_SLOTS.forEach(s=>{
                                            if(!dayData[s.id]) {
                                                if(s.type==='24' && poolA.length) dayData[s.id]=poolA.pop().id;
                                                else if(s.type!=='24') {
                                                    if(poolB.length) dayData[s.id]=poolB.pop().id;
                                                    else if(poolA.length) dayData[s.id]=poolA.pop().id;
                                                }
                                            }
                                        });
                                        setAssignments({...assignments, [k]: dayData});
                                    }} className="bg-purple-600 text-white px-4 py-2 rounded font-bold flex items-center gap-2 hover:bg-purple-700 shadow"><Icons.Sparkles size={18}/> RASTGELE DOLDUR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


