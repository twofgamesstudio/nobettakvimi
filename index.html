<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acil Servis Nöbet Planlama</title>
    <!-- HTML2Canvas kütüphanesi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- İkon seti -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --danger: #ef4444;
            --success: #16a34a;
            --bg-light: #f1f5f9;
            --border: #cbd5e1;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: #334155;
        }

        /* --- Header ve Kontroller --- */
        header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        h1 { margin: 0; font-size: 1.5rem; color: var(--primary-dark); font-weight: 700; }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, input[type="month"] {
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            outline: none;
        }
        select:focus, input:focus { border-color: var(--primary); }

        button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: white; border: 1px solid var(--border); color: var(--secondary); }
        .btn-secondary:hover { background-color: #f8fafc; border-color: #94a3b8; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn-danger { background-color: var(--danger); color: white; }

        /* --- Ana Alan --- */
        main {
            padding: 2rem;
            max-width: 100%;
            overflow-x: auto; /* Ekranda taşmayı engellemek için kaydırma çubuğu */
        }

        /* --- Tablo Tasarımı --- */
        .schedule-container {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid var(--border);
            display: inline-block;
            min-width: 100%;
        }

        table {
            border-collapse: collapse;
            font-size: 0.8rem;
            width: 100%;
            white-space: nowrap;
        }

        th, td {
            border: 1px solid #94a3b8;
            padding: 8px 4px;
            text-align: center;
            vertical-align: middle;
            color: #0f172a;
        }

        th {
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        /* Özel Sütunlar ve Renkler */
        .col-date { width: 60px; background: #e2e8f0; font-weight: 800; color: #1e293b; }
        
        /* Renk Paleti - Canlı ve Okunaklı */
        .area-header-yellow { background-color: #fef08a !important; color: #854d0e; }
        .area-header-female { background-color: #fbcfe8 !important; color: #9d174d; }
        .area-header-male { background-color: #bfdbfe !important; color: #1e40af; }
        .area-header-triage { background-color: #fed7aa !important; color: #9a3412; }
        .area-header-green { background-color: #bbf7d0 !important; color: #166534; }
        .area-header-short { background-color: #ddd6fe !important; color: #5b21b6; }

        .weekend { background-color: #f8fafc; }
        .sunday { background-color: #fff1f2; } /* Pazar günleri hafif kırmızımsı */
        
        .empty-slot { background-color: #ef4444; color: white; font-weight: bold; }
        .filled-slot { font-weight: 500; }

        /* --- Modal (Personel Ekleme) --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        .staff-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 0.75rem;
            overflow-y: auto;
            padding: 5px;
            flex: 1;
        }

        .staff-card {
            border: 1px solid var(--border);
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .staff-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-color: var(--primary); }

        .staff-info h4 { margin: 0 0 4px 0; font-size: 0.9rem; color: #334155; }
        .staff-info .badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .badge.group-A { background: #dbeafe; color: #1e40af; }
        .badge.group-B { background: #fce7f3; color: #9d174d; }

        .leave-manager {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px dashed var(--border);
            margin-top: 1rem;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            background: #e2e8f0;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.8rem;
            margin: 2px;
            color: #475569;
        }
        .chip i { margin-left: 6px; cursor: pointer; color: #94a3b8; }
        .chip i:hover { color: #ef4444; }

        /* --- Loading Animasyonu --- */
        #loading {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 200;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:1rem;">
        <div style="background:var(--primary); width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white;">
            <i class="fas fa-hospital-user fa-lg"></i>
        </div>
        <div>
            <h1>Acil Nöbet</h1>
            <small style="color:var(--secondary); font-weight:500;">Otomatik Planlama Sistemi v2.0</small>
        </div>
    </div>
    
    <div class="controls">
        <input type="month" id="targetDate" onchange="updateTableHeaders()">
        <button class="btn-secondary" onclick="openStaffModal()"><i class="fas fa-users-cog"></i> Personel</button>
        <button class="btn-primary" onclick="generateSchedule()"><i class="fas fa-bolt"></i> Listeyi Oluştur</button>
        <button class="btn-success" onclick="downloadImage()"><i class="fas fa-file-download"></i> JPG İndir (HQ)</button>
    </div>
</header>

<main>
    <!-- Görüntülenecek Alan -->
    <div id="displayWrapper">
        <div class="schedule-container" id="scheduleContainer">
            <table id="scheduleTable">
                <thead>
                    <tr>
                        <th class="col-date" rowspan="2">GÜN</th>
                        <th class="area-header-yellow" colspan="4">SARI ALAN (24s)</th>
                        <th class="area-header-female" colspan="3">KADIN GÖZLEM (24s)</th>
                        <th class="area-header-male" colspan="3">ERKEK GÖZLEM (24s)</th>
                        <th class="area-header-triage" colspan="2">TRİAJ (24s)</th>
                        <th class="area-header-green" colspan="2">YEŞİL ALAN (24s)</th>
                        <th class="area-header-short" colspan="2">KISA TRİAJ</th>
                        <th class="area-header-short" colspan="2">KISA YEŞİL</th>
                    </tr>
                    <tr>
                        <th class="area-header-yellow">1</th> <th class="area-header-yellow">2</th> <th class="area-header-yellow">3</th> <th class="area-header-yellow">4</th>
                        <th class="area-header-female">1</th> <th class="area-header-female">2</th> <th class="area-header-female">3</th>
                        <th class="area-header-male">1</th> <th class="area-header-male">2</th> <th class="area-header-male">3</th>
                        <th class="area-header-triage">1</th> <th class="area-header-triage">2</th>
                        <th class="area-header-green">1</th> <th class="area-header-green">2</th>
                        <th class="area-header-short">8 Saat</th> <th class="area-header-short">16 Saat</th>
                        <th class="area-header-short">8 Saat</th> <th class="area-header-short">16 Saat</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Javascript ile doldurulacak -->
                </tbody>
            </table>
        </div>
        <div style="padding: 15px; font-size: 0.85rem; color: #64748b; background:white; border:1px solid var(--border); border-top:none; border-radius: 0 0 0.5rem 0.5rem;">
            <i class="fas fa-info-circle"></i> <strong>Bilgilendirme:</strong> Grup B personeli öncelikli olarak kısa nöbetlere (8/16s) yerleştirilir. 
            İzinli personele nöbet yazılmaz. 24 saat nöbet tutan personele ertesi gün dinlenme verilir.
        </div>
    </div>
</main>

<!-- Personel Yönetimi Modal -->
<div id="staffModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0; color:var(--primary-dark);">Personel Yönetimi</h3>
            <button onclick="closeStaffModal()" style="background:transparent; border:none; font-size:1.5rem; color:#64748b;">&times;</button>
        </div>
        
        <div style="display:flex; gap:1rem; margin-bottom:1rem; padding-bottom:1rem; border-bottom:1px solid #eee;">
            <input type="text" id="newStaffName" placeholder="Ad Soyad Giriniz" style="flex:2">
            <select id="newStaffGroup" style="flex:1">
                <option value="A">Grup A (Tüm Nöbetler)</option>
                <option value="B">Grup B (Sadece 8/16s)</option>
            </select>
            <button class="btn-primary" onclick="addStaff()">Ekle</button>
        </div>

        <!-- Personel Düzenleme Alanı -->
        <div id="editStaffArea" style="display:none; margin-bottom:1rem;">
            <div style="background:#eff6ff; padding:1rem; border-radius:0.5rem; border:1px solid #bfdbfe;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 id="editingStaffName" style="margin:0; color:var(--primary-dark); font-size:1.1rem;"></h4>
                    <button onclick="deleteStaff()" class="btn-danger" style="padding:0.4rem 0.8rem; font-size:0.8rem;">Personeli Sil</button>
                </div>
                
                <div class="leave-manager">
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#475569;">İzin / Boş Gün Ekle:</label>
                    <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                        <input type="date" id="leaveDateInput">
                        <button class="btn-secondary" onclick="addLeaveToStaff()">Ekle</button>
                    </div>
                    <div id="leaveChips" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
                </div>
                <div style="text-align:right; margin-top:10px;">
                     <button class="btn-secondary" onclick="closeEditArea()">Düzenlemeyi Bitir</button>
                </div>
            </div>
        </div>

        <div class="staff-list-grid" id="staffListGrid">
            <!-- JS ile dolacak -->
        </div>
        <div style="margin-top:1rem; text-align:right;">
             <button class="btn-secondary" onclick="if(confirm('Tüm personel listesi sıfırlanıp varsayılan listeye dönülecek. Onaylıyor musunuz?')) resetStaffData();" style="font-size:0.8rem; color:#94a3b8;">Varsayılan Listeyi Geri Yükle</button>
        </div>
    </div>
</div>

<div id="loading">
    <div class="spinner"></div>
    <h3 id="loadingTitle" style="margin-top:20px; color:#333;">İşlem Yapılıyor...</h3>
    <p id="loadingText" style="color:#666;">Lütfen bekleyiniz.</p>
</div>

<script>
    // --- Varsayılan Veriler ---
    const defaultGroupA = [
        "ABDURRAHMAN ŞAHİN", "AHMET ALTINTAŞ", "AHMET KAYA", "ALEYNA NUR ÇELİK", "ALİ İHSAN ÖZDEMİR",
        "ARZU BOZBOĞA", "ASENA ALBAYRAK", "AYŞE ÇETİN", "AYŞE SAN", "BURAKHAN KARAKAN", "BÜŞRA DEŞAT",
        "BÜŞRA KESKİN", "CANER KARAMAN", "CEREN CAN EMRE", "CUMALİ ORUÇ", "DÖNDÜ KARACA KOÇ", "EBRU TEKTAŞ",
        "EBUBEKİR BOZKURT", "ERDİ ŞEN", "ESRA KESKİN", "FATİH KÖYLÜ", "FUAT ÇOBAN", "GİZEM TÜRKER",
        "GONCA METİN", "GÖKHAN AKGÜL", "HACER AKYÜREK", "HATİCE EREN", "HİLAL KORUYAN", "İFAKET DUMLU",
        "KADİR KAYA", "KADRIYE ÖZKAN", "MERVE NUR DEMİRTAŞ", "MUHAMMED TATLI", "OKTAY KARAHAN", "ÖZGE KUŞ",
        "RABİA KAHRİMAN", "RABİA YAVAŞ KAYA", "RAMAZAN BİLGİN", "RECAİ KARAHAN", "REMZİYE YALMAN",
        "REMZİYE YATBAZ", "SELMA SERTELLİ", "SEMİHA ADIYAMAN", "SERHAT DURAK", "ŞAFAK TAŞTAN",
        "ŞAZİMET AYTEKİN", "ERDİ GÜREL", "TUĞBA DENİZ GÜREL", "VURAL GÜLEÇ", "YARENGÜZEL AŞÇI",
        "YASEMİN ERDEM", "YASİN KİRAZ", "YUNUS EMRE YILDIZ", "ZEHRA TEKBIÇAK"
    ];

    const defaultGroupB = [
        "PINAR İLÇİN", "ÖZLEM BOZKURT", "NURCAN ÇİFTÇİ", "MERVE POYRAZ", "CANSU ÖZEN",
        "BURCU KIYAK", "FATMA KIRTAŞ", "HÜLYA ŞAHİN", "SÜMEYYE KARAKAYA"
    ];

    // --- Durum Yönetimi ---
    let staffList = [];
    let currentSchedule = {};
    let editingStaffId = null;

    // --- Başlangıç ---
    window.onload = function() {
        const now = new Date();
        const monthStr = now.toISOString().slice(0, 7);
        document.getElementById('targetDate').value = monthStr;

        loadStaff();
        updateTableHeaders();
    };

    // --- Veri Fonksiyonları ---
    function loadStaff() {
        const stored = localStorage.getItem('hospitalStaffList');
        if (stored) {
            staffList = JSON.parse(stored);
        } else {
            resetStaffData();
        }
    }

    function saveStaff() {
        localStorage.setItem('hospitalStaffList', JSON.stringify(staffList));
        renderStaffList();
    }

    function resetStaffData() {
        staffList = [];
        let idCounter = 1;
        defaultGroupA.forEach(name => {
            staffList.push({ id: idCounter++, name: name, group: 'A', leaves: [] });
        });
        defaultGroupB.forEach(name => {
            staffList.push({ id: idCounter++, name: name, group: 'B', leaves: [] });
        });
        saveStaff();
    }

    // --- Arayüz Fonksiyonları ---
    function openStaffModal() {
        document.getElementById('staffModal').style.display = 'flex';
        renderStaffList();
    }

    function closeStaffModal() {
        document.getElementById('staffModal').style.display = 'none';
        document.getElementById('editStaffArea').style.display = 'none';
    }

    function renderStaffList() {
        const container = document.getElementById('staffListGrid');
        container.innerHTML = '';
        
        staffList.sort((a,b) => a.name.localeCompare(b.name)).forEach(staff => {
            const div = document.createElement('div');
            div.className = 'staff-card';
            div.style.cursor = 'pointer';
            div.onclick = () => editStaff(staff.id);
            
            const leaveCount = staff.leaves.length;
            const leaveHtml = leaveCount > 0 
                ? `<div style="margin-top:5px; font-size:0.75rem; color:#ef4444;"><i class="fas fa-calendar-times"></i> ${leaveCount} İzin</div>` 
                : '';

            div.innerHTML = `
                <div class="staff-info">
                    <h4>${staff.name}</h4>
                    <span class="badge group-${staff.group}">Grup ${staff.group}</span>
                    ${leaveHtml}
                </div>
                <i class="fas fa-pen" style="color:#cbd5e1"></i>
            `;
            container.appendChild(div);
        });
    }

    function addStaff() {
        const nameInput = document.getElementById('newStaffName');
        const name = nameInput.value.trim().toUpperCase();
        const group = document.getElementById('newStaffGroup').value;
        if (!name) return alert('Lütfen isim giriniz.');

        const newId = staffList.length > 0 ? Math.max(...staffList.map(s => s.id)) + 1 : 1;
        staffList.push({ id: newId, name: name, group: group, leaves: [] });
        nameInput.value = '';
        saveStaff();
    }

    function editStaff(id) {
        editingStaffId = id;
        const staff = staffList.find(s => s.id === id);
        if (!staff) return;

        document.getElementById('editStaffArea').style.display = 'block';
        document.getElementById('editingStaffName').innerText = staff.name;
        renderLeaves(staff);
    }

    function closeEditArea() {
        editingStaffId = null;
        document.getElementById('editStaffArea').style.display = 'none';
    }

    function deleteStaff() {
        if (!editingStaffId) return;
        if (confirm('Bu personeli listeden silmek istediğinize emin misiniz?')) {
            staffList = staffList.filter(s => s.id !== editingStaffId);
            saveStaff();
            closeEditArea();
        }
    }

    function addLeaveToStaff() {
        if (!editingStaffId) return;
        const dateVal = document.getElementById('leaveDateInput').value;
        if (!dateVal) return;

        const staff = staffList.find(s => s.id === editingStaffId);
        if (!staff.leaves.includes(dateVal)) {
            staff.leaves.push(dateVal);
            staff.leaves.sort();
            saveStaff();
            renderLeaves(staff);
        }
        document.getElementById('leaveDateInput').value = '';
    }

    function removeLeave(dateStr) {
        if (!editingStaffId) return;
        const staff = staffList.find(s => s.id === editingStaffId);
        staff.leaves = staff.leaves.filter(d => d !== dateStr);
        saveStaff();
        renderLeaves(staff);
    }

    function renderLeaves(staff) {
        const container = document.getElementById('leaveChips');
        container.innerHTML = '';
        if(staff.leaves.length === 0) {
            container.innerHTML = '<span style="font-size:0.8rem; color:#94a3b8; font-style:italic;">Kayıtlı izin yok.</span>';
            return;
        }
        staff.leaves.forEach(date => {
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.innerHTML = `${date.split('-').reverse().join('.')} <i class="fas fa-times-circle" onclick="event.stopPropagation(); removeLeave('${date}')"></i>`;
            container.appendChild(chip);
        });
    }

    // --- Nöbet Dağıtım Algoritması ---
    function getDaysInMonth(year, month) {
        return new Date(year, month, 0).getDate();
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    async function generateSchedule() {
        document.getElementById('loadingTitle').innerText = "Nöbetler Dağıtılıyor";
        document.getElementById('loadingText').innerText = "Algoritma çalışıyor...";
        document.getElementById('loading').style.display = 'flex';
        
        setTimeout(() => {
            const dateInput = document.getElementById('targetDate').value;
            const [year, month] = dateInput.split('-').map(Number);
            const daysInMonth = getDaysInMonth(year, month);
            
            // Slot Tanımları
            const slotsDefinition = [
                { id: 'y1', name: 'Sarı', type: '24h', group: 'A' },
                { id: 'y2', name: 'Sarı', type: '24h', group: 'A' },
                { id: 'y3', name: 'Sarı', type: '24h', group: 'A' },
                { id: 'y4', name: 'Sarı', type: '24h', group: 'A' },
                { id: 'f1', name: 'Kadın', type: '24h', group: 'A' },
                { id: 'f2', name: 'Kadın', type: '24h', group: 'A' },
                { id: 'f3', name: 'Kadın', type: '24h', group: 'A' },
                { id: 'm1', name: 'Erkek', type: '24h', group: 'A' },
                { id: 'm2', name: 'Erkek', type: '24h', group: 'A' },
                { id: 'm3', name: 'Erkek', type: '24h', group: 'A' },
                { id: 't1', name: 'Triaj', type: '24h', group: 'A' },
                { id: 't2', name: 'Triaj', type: '24h', group: 'A' },
                { id: 'g1', name: 'Yeşil', type: '24h', group: 'A' },
                { id: 'g2', name: 'Yeşil', type: '24h', group: 'A' },
                { id: 'st8', name: 'T.Kısa8', type: 'short', group: 'Any' },
                { id: 'st16', name: 'T.Kısa16', type: 'short', group: 'Any' },
                { id: 'sg8', name: 'Y.Kısa8', type: 'short', group: 'Any' },
                { id: 'sg16', name: 'Y.Kısa16', type: 'short', group: 'Any' },
            ];

            let schedule = {}; 
            let staffState = {}; 
            
            // State Sıfırlama
            staffList.forEach(s => {
                staffState[s.id] = { lastShiftDay: -999, shiftCount: 0 };
            });

            for (let day = 1; day <= daysInMonth; day++) {
                schedule[day] = {};
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let assignedToday = new Set();

                // 1. Kısa Nöbetleri Dağıt (Önce Grup B)
                const shortSlots = slotsDefinition.filter(s => s.type === 'short');
                let availableGroupB = shuffleArray(staffList.filter(s => s.group === 'B'));
                let availableGroupA = shuffleArray(staffList.filter(s => s.group === 'A'));

                shortSlots.forEach(slot => {
                    // Grup B'den bul
                    let candidate = availableGroupB.find(s => 
                        !assignedToday.has(s.id) && 
                        !s.leaves.includes(dateStr) &&
                        (day - staffState[s.id].lastShiftDay > 0)
                    );

                    // Yoksa Grup A'dan bul (Dün 24 saat tutmamış olmalı)
                    if (!candidate) {
                        candidate = availableGroupA.find(s => 
                            !assignedToday.has(s.id) && 
                            !s.leaves.includes(dateStr) &&
                            (day - staffState[s.id].lastShiftDay >= 1)
                        );
                    }

                    if (candidate) {
                        schedule[day][slot.id] = candidate;
                        assignedToday.add(candidate.id);
                        staffState[candidate.id].lastShiftDay = day;
                        staffState[candidate.id].shiftCount++;
                    } else {
                        schedule[day][slot.id] = { name: "---" };
                    }
                });

                // 2. 24 Saatlik Nöbetleri Dağıt (Sadece Grup A)
                const longSlots = slotsDefinition.filter(s => s.type === '24h');
                
                // En az nöbet tutanı öne al (Adalet)
                availableGroupA.sort((a, b) => {
                    if (staffState[a.id].shiftCount === staffState[b.id].shiftCount) return 0.5 - Math.random();
                    return staffState[a.id].shiftCount - staffState[b.id].shiftCount;
                });

                longSlots.forEach(slot => {
                    const candidate = availableGroupA.find(s => 
                        !assignedToday.has(s.id) && 
                        !s.leaves.includes(dateStr) &&
                        (day - staffState[s.id].lastShiftDay > 1) // En az 1 tam gün boşluk
                    );

                    if (candidate) {
                        schedule[day][slot.id] = candidate;
                        assignedToday.add(candidate.id);
                        staffState[candidate.id].lastShiftDay = day;
                        staffState[candidate.id].shiftCount++;
                    } else {
                         schedule[day][slot.id] = { name: "BOŞ!" };
                    }
                });
            }

            currentSchedule = schedule;
            renderTable(year, month);
            document.getElementById('loading').style.display = 'none';
        }, 100);
    }

    function renderTable(year, month) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const daysInMonth = getDaysInMonth(year, month);
        const dayNames = ["Paz", "Pzt", "Sal", "Çar", "Per", "Cum", "Cts"];

        const slotIds = ['y1','y2','y3','y4','f1','f2','f3','m1','m2','m3','t1','t2','g1','g2','st8','st16','sg8','sg16'];

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const dayName = dayNames[date.getDay()];
            const row = document.createElement('tr');
            
            if (date.getDay() === 0) row.classList.add('sunday'); 
            else if (date.getDay() === 6) row.classList.add('weekend');

            const dateCell = document.createElement('td');
            dateCell.className = 'col-date';
            dateCell.innerHTML = `<div>${day}</div><div style="font-weight:normal; font-size:0.7em; text-transform:uppercase;">${dayName}</div>`;
            row.appendChild(dateCell);

            slotIds.forEach(id => {
                const cell = document.createElement('td');
                const staff = (currentSchedule[day] || {})[id];
                if (staff) {
                    cell.innerText = staff.name;
                    cell.classList.add('filled-slot');
                    if (staff.name === "BOŞ!") cell.className = 'empty-slot';
                } else {
                    cell.innerText = "-";
                    cell.style.color = "#ccc";
                }
                row.appendChild(cell);
            });
            tbody.appendChild(row);
        }
    }

    function updateTableHeaders() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="19" style="padding:40px; text-align:center; color:#64748b; font-size:1.1rem;"><i class="fas fa-magic fa-2x" style="margin-bottom:10px; display:block;"></i>Lütfen "Listeyi Oluştur" butonuna basınız.</td></tr>';
    }

    // --- YENİLENMİŞ JPG İNDİRME FONKSİYONU ---
    function downloadImage() {
        document.getElementById('loadingTitle').innerText = "Yüksek Kaliteli Görsel Hazırlanıyor";
        document.getElementById('loadingText').innerText = "Tablo ne kadar büyük olursa olsun, tamamı eksiksiz alınıyor...";
        document.getElementById('loading').style.display = 'flex';

        setTimeout(() => {
            // 1. Orijinal tablo yapısını kopyala
            const originalContainer = document.querySelector('.schedule-container');
            if (!originalContainer) return;

            // 2. Klon oluştur ve baskı için optimize et
            const clone = originalContainer.cloneNode(true);
            
            // Tarih başlığını ekle
            const dateVal = document.getElementById('targetDate').value;
            const headerDiv = document.createElement('div');
            headerDiv.style.textAlign = 'center';
            headerDiv.style.padding = '20px';
            headerDiv.style.background = 'white';
            headerDiv.style.borderBottom = '2px solid #000';
            headerDiv.style.marginBottom = '0';
            headerDiv.innerHTML = `<h2 style="margin:0; font-size:24px; color:#000;">ACİL SERVİS NÖBET LİSTESİ - ${dateVal}</h2>`;
            
            // Klon konteyner (Wrapper)
            const wrapper = document.createElement('div');
            wrapper.style.position = 'absolute';
            wrapper.style.top = '0';
            wrapper.style.left = '0';
            // Ekranın dışına atmak yerine en üstte, görünmez bir katmanda tutalım ama render edilsin
            wrapper.style.zIndex = '-9999'; 
            wrapper.style.width = 'fit-content'; // İçeriğe göre genişle
            wrapper.style.minWidth = '1400px';
            wrapper.style.background = 'white';
            wrapper.style.padding = '20px';
            
            // Klon Stilleri (Baskı Modu)
            clone.style.boxShadow = 'none';
            clone.style.border = '2px solid #000';
            clone.style.borderRadius = '0';
            clone.style.overflow = 'visible'; // Scroll olmasın, taşsın
            clone.style.width = 'auto';
            clone.style.display = 'table'; // Tam genişlik zorla

            // Klonun içindeki tüm hücre kenarlıklarını siyah yap (Net baskı için)
            const allCells = clone.querySelectorAll('th, td');
            allCells.forEach(cell => {
                cell.style.borderColor = '#000';
                cell.style.color = '#000';
                if(cell.tagName === 'TH') cell.style.background = '#e2e8f0'; // Başlıkları grileştir
            });

            wrapper.appendChild(headerDiv);
            wrapper.appendChild(clone);
            document.body.appendChild(wrapper);

            // 3. HTML2Canvas ile yakala
            html2canvas(wrapper, {
                scale: 5, // 5 kat kalite (Çok net)
                useCORS: true,
                backgroundColor: '#ffffff',
                windowWidth: wrapper.scrollWidth + 100, // Genişlik sınırı yok
                width: wrapper.scrollWidth + 40,
                height: wrapper.scrollHeight + 40,
                x: 0,
                y: 0
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Acil_Nobet_Listesi_${dateVal}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
                
                // Temizlik
                document.body.removeChild(wrapper);
                document.getElementById('loading').style.display = 'none';
            }).catch(err => {
                alert('Hata oluştu: ' + err);
                if(wrapper) document.body.removeChild(wrapper);
                document.getElementById('loading').style.display = 'none';
            });
        }, 500);
    }
</script>

</body>
</html>
