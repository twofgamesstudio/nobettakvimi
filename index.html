import React, { useState, useEffect, useRef } from 'react';
import { Calendar, Users, Printer, Trash2, Plus, FileSpreadsheet, ChevronLeft, ChevronRight, X, Sparkles, Check, AlertTriangle, Menu, Image as ImageIcon, FileText } from 'lucide-react';

// --- VERİ YAPILARI ---

const INITIAL_STAFF = [
  // GRUP A (24 Saat tutabilenler)
  { id: 1, name: "ABDURRAHMAN ŞAHİN", group: "A" },
  { id: 2, name: "AHMET ALTINTAŞ", group: "A" },
  { id: 3, name: "AHMET KAYA", group: "A" },
  { id: 4, name: "ALEYNA NUR ÇELİK", group: "A" },
  { id: 5, name: "ALİ İHSAN ÖZDEMİR", group: "A" },
  { id: 6, name: "ARZU BOZBOĞA", group: "A" },
  { id: 7, name: "ASENA ALBAYRAK", group: "A" },
  { id: 8, name: "AYŞE ÇETİN", group: "A" },
  { id: 9, name: "AYŞE SAN", group: "A" },
  { id: 10, name: "BURAKHAN KARAKAN", group: "A" },
  { id: 11, name: "BÜŞRA DEŞAT", group: "A" },
  { id: 12, name: "BÜŞRA KESKİN", group: "A" },
  { id: 13, name: "CANER KARAMAN", group: "A" },
  { id: 14, name: "CEREN CAN EMRE", group: "A" },
  { id: 15, name: "CUMALİ ORUÇ", group: "A" },
  { id: 16, name: "DÖNDÜ KARACA KOÇ", group: "A" },
  { id: 17, name: "EBRU TEKTAŞ", group: "A" },
  { id: 18, name: "EBUBEKİR BOZKURT", group: "A" },
  { id: 19, name: "ERDİ ŞEN", group: "A" },
  { id: 20, name: "ESRA KESKİN", group: "A" },
  { id: 21, name: "FATİH KÖYLÜ", group: "A" },
  { id: 22, name: "FUAT ÇOBAN", group: "A" },
  { id: 23, name: "GİZEM TÜRKER", group: "A" },
  { id: 24, name: "GONCA METİN", group: "A" },
  { id: 25, name: "GÖKHAN AKGÜL", group: "A" },
  { id: 26, name: "HACER AKYÜREK", group: "A" },
  { id: 27, name: "HATİCE EREN", group: "A" },
  { id: 28, name: "HİLAL KORUYAN", group: "A" },
  { id: 29, name: "İFAKET DUMLU", group: "A" },
  { id: 30, name: "KADİR KAYA", group: "A" },
  { id: 31, name: "KADRIYE ÖZKAN", group: "A" },
  { id: 32, name: "MERVE NUR DEMİRTAŞ", group: "A" },
  { id: 33, name: "MUHAMMED TATLI", group: "A" },
  { id: 34, name: "OKTAY KARAHAN", group: "A" },
  { id: 35, name: "ÖZGE KUŞ", group: "A" },
  { id: 36, name: "RABİA KAHRİMAN", group: "A" },
  { id: 37, name: "RABİA YAVAŞ KAYA", group: "A" },
  { id: 38, name: "RAMAZAN BİLGİN", group: "A" },
  { id: 39, name: "RECAİ KARAHAN", group: "A" },
  { id: 40, name: "REMZİYE YALMAN", group: "A" },
  { id: 41, name: "REMZİYE YATBAZ", group: "A" },
  { id: 42, name: "SELMA SERTELLİ", group: "A" },
  { id: 43, name: "SEMİHA ADIYAMAN", group: "A" },
  { id: 44, name: "SERHAT DURAK", group: "A" },
  { id: 45, name: "ŞAFAK TAŞTAN", group: "A" },
  { id: 46, name: "ŞAZİMET AYTEKİN", group: "A" },
  { id: 47, name: "ERDİ GÜREL", group: "A" },
  { id: 48, name: "TUĞBA DENİZ GÜREL", group: "A" },
  { id: 49, name: "VURAL GÜLEÇ", group: "A" },
  { id: 50, name: "YARENGÜZEL AŞÇI", group: "A" },
  { id: 51, name: "YASEMİN ERDEM", group: "A" },
  { id: 52, name: "YASİN KİRAZ", group: "A" },
  { id: 53, name: "YUNUS EMRE YILDIZ", group: "A" },
  { id: 54, name: "ZEHRA TEKBIÇAK", group: "A" },
  { id: 64, name: "YENİ PERSONEL A", group: "A" }, 

  // GRUP B (Sadece 8-16 Saat tutabilenler)
  { id: 55, name: "PINAR İLÇİN", group: "B" },
  { id: 56, name: "ÖZLEM BOZKURT", group: "B" },
  { id: 57, name: "NURCAN ÇİFTÇİ", group: "B" },
  { id: 58, name: "MERVE POYRAZ", group: "B" },
  { id: 59, name: "CANSU ÖZEN", group: "B" },
  { id: 60, name: "BURCU KIYAK", group: "B" },
  { id: 61, name: "FATMA KIRTAŞ", group: "B" },
  { id: 62, name: "HÜLYA ŞAHİN", group: "B" },
  { id: 63, name: "SÜMEYYE KARAKAYA", group: "B" },
];

const DUTY_SLOTS = [
  // 24 SAATLİK (14 Kişi)
  { id: 'sari_1', label: 'Sarı Alan 1', type: '24', area: 'Sarı Alan' },
  { id: 'sari_2', label: 'Sarı Alan 2', type: '24', area: 'Sarı Alan' },
  { id: 'sari_3', label: 'Sarı Alan 3', type: '24', area: 'Sarı Alan' },
  { id: 'sari_4', label: 'Sarı Alan 4', type: '24', area: 'Sarı Alan' },
  { id: 'kadin_1', label: 'Kadın Gözlem 1', type: '24', area: 'Kadın Gözlem' },
  { id: 'kadin_2', label: 'Kadın Gözlem 2', type: '24', area: 'Kadın Gözlem' },
  { id: 'kadin_3', label: 'Kadın Gözlem 3', type: '24', area: 'Kadın Gözlem' },
  { id: 'erkek_1', label: 'Erkek Gözlem 1', type: '24', area: 'Erkek Gözlem' },
  { id: 'erkek_2', label: 'Erkek Gözlem 2', type: '24', area: 'Erkek Gözlem' },
  { id: 'erkek_3', label: 'Erkek Gözlem 3', type: '24', area: 'Erkek Gözlem' },
  { id: 'triaj_24_1', label: 'Triaj 1 (24s)', type: '24', area: 'Triaj' },
  { id: 'triaj_24_2', label: 'Triaj 2 (24s)', type: '24', area: 'Triaj' },
  { id: 'yesil_24_1', label: 'Yeşil Alan 1 (24s)', type: '24', area: 'Yeşil Alan' },
  { id: 'yesil_24_2', label: 'Yeşil Alan 2 (24s)', type: '24', area: 'Yeşil Alan' },

  // KISA NÖBETLER (4 Kişi)
  { id: 'triaj_16', label: 'Triaj (16s)', type: '16', area: 'Triaj' },
  { id: 'yesil_16', label: 'Yeşil Alan (16s)', type: '16', area: 'Yeşil Alan' },
  { id: 'triaj_8', label: 'Triaj (8s)', type: '8', area: 'Triaj' },
  { id: 'yesil_8', label: 'Yeşil Alan (8s)', type: '8', area: 'Yeşil Alan' },
];

const MONTHS = [
  "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran",
  "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"
];

// --- AYRIŞTIRILMIŞ BİLEŞEN: StaffManager ---
const StaffManager = ({ staffList, setStaffList, showNotification }) => {
    const [newName, setNewName] = useState("");
    const [newGroup, setNewGroup] = useState("A");
    const [deleteConfirmId, setDeleteConfirmId] = useState(null);

    const addStaff = () => {
        if(!newName) return;
        const maxId = staffList.length > 0 ? Math.max(...staffList.map(s => s.id)) : 0;
        setStaffList([...staffList, { id: maxId + 1, name: newName.toUpperCase(), group: newGroup }]);
        setNewName("");
        showNotification("Personel başarıyla eklendi.", "success");
    }

    const deleteStaff = (id) => {
        if (deleteConfirmId === id) {
            setStaffList(staffList.filter(s => s.id !== id));
            setDeleteConfirmId(null);
            showNotification("Personel silindi.", "success");
        } else {
            setDeleteConfirmId(id);
            setTimeout(() => setDeleteConfirmId(null), 3000);
        }
    }

    return (
        <div className="bg-white p-4 md:p-6 rounded-lg shadow-lg">
            <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Users /> Personel Yönetimi</h2>
            
            <div className="flex flex-col md:flex-row gap-2 mb-6">
                <input 
                    type="text" 
                    placeholder="Ad Soyad" 
                    className="border p-2 rounded flex-1 uppercase w-full"
                    value={newName}
                    onChange={(e) => setNewName(e.target.value)}
                />
                <select 
                    className="border p-2 rounded w-full md:w-auto"
                    value={newGroup}
                    onChange={(e) => setNewGroup(e.target.value)}
                >
                    <option value="A">Grup A (Her Şey)</option>
                    <option value="B">Grup B (Kısa Nöbet)</option>
                </select>
                <button onClick={addStaff} className="bg-green-600 text-white p-2 rounded hover:bg-green-700 flex items-center justify-center gap-1 w-full md:w-auto">
                    <Plus size={18} /> Ekle
                </button>
            </div>

            <div className="max-h-[500px] overflow-y-auto border rounded">
                <table className="w-full text-sm">
                    <thead className="bg-gray-100 sticky top-0">
                        <tr>
                            <th className="p-2 text-left">İsim</th>
                            <th className="p-2 text-center">Grup</th>
                            <th className="p-2 text-right">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {staffList.map(staff => (
                            <tr key={staff.id} className="border-t hover:bg-gray-50">
                                <td className="p-2">{staff.name}</td>
                                <td className="p-2 text-center">
                                    <span className={`px-2 py-0.5 rounded text-xs ${staff.group === 'A' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}`}>
                                        {staff.group}
                                    </span>
                                </td>
                                <td className="p-2 text-right">
                                    <button 
                                        onClick={() => deleteStaff(staff.id)} 
                                        className={`flex items-center gap-1 ml-auto px-2 py-1 rounded transition-colors ${deleteConfirmId === staff.id ? 'bg-red-600 text-white' : 'text-red-500 hover:bg-red-50'}`}
                                    >
                                        {deleteConfirmId === staff.id ? (
                                            <>Onayla <Check size={14}/></>
                                        ) : (
                                            <Trash2 size={16} />
                                        )}
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    )
}

// --- ANA BİLEŞEN ---

export default function App() {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [staffList, setStaffList] = useState(INITIAL_STAFF);
  const [assignments, setAssignments] = useState({});
  const [selectedDay, setSelectedDay] = useState(null);
  const [viewMode, setViewMode] = useState('calendar');
  const [notification, setNotification] = useState(null);
  const [showAutoFillConfirm, setShowAutoFillConfirm] = useState(false);
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  
  const matrixRef = useRef(null);

  const showNotification = (message, type = 'info') => {
      setNotification({ message, type });
      setTimeout(() => setNotification(null), 3000);
  };

  const getDaysInMonth = (date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const days = new Date(year, month + 1, 0).getDate();
    return Array.from({ length: days }, (_, i) => i + 1);
  };

  const formatDateKey = (year, month, day) => {
    return `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
  };

  const getDayName = (day) => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const date = new Date(year, month, day);
    return date.toLocaleDateString('tr-TR', { weekday: 'short' });
  };

  const changeMonth = (delta) => {
    const newDate = new Date(currentDate);
    newDate.setMonth(newDate.getMonth() + delta);
    setCurrentDate(newDate);
  };

  // --- İSTATİSTİKLER ---
  const calculateStats = () => {
    const stats = {};
    staffList.forEach(s => stats[s.id] = { hours: 0, shifts: 0 });

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    const prefix = `${year}-${month.toString().padStart(2, '0')}`;

    Object.keys(assignments).forEach(dateKey => {
      if (dateKey.startsWith(prefix)) {
        const dayAssignments = assignments[dateKey];
        Object.keys(dayAssignments).forEach(slotId => {
          const staffId = dayAssignments[slotId];
          const slotDef = DUTY_SLOTS.find(s => s.id === slotId);
          if (staffId && stats[staffId] && slotDef) {
            stats[staffId].shifts += 1;
            stats[staffId].hours += parseInt(slotDef.type);
          }
        });
      }
    });
    return stats;
  };

  const stats = calculateStats();

  const handleAssignment = (slotId, staffId) => {
    if (!selectedDay) return;
    const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);
    
    setAssignments(prev => {
      const dayData = prev[dateKey] || {};
      const existingSlot = Object.keys(dayData).find(key => dayData[key] == staffId);
      if (existingSlot && existingSlot !== slotId && staffId !== "") {
        const staffName = staffList.find(s=>s.id == staffId)?.name;
        showNotification(`${staffName} zaten bu gün görevli!`, "error");
        return prev;
      }
      const updatedDayData = { ...dayData, [slotId]: staffId };
      if (!staffId) delete updatedDayData[slotId];
      return { ...prev, [dateKey]: updatedDayData };
    });
  };

  const autoFillMonth = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const days = getDaysInMonth(currentDate);
    
    const newAssignments = { ...assignments };
    const prefix = `${year}-${(month + 1).toString().padStart(2, '0')}`;
    Object.keys(newAssignments).forEach(k => {
        if(k.startsWith(prefix)) delete newAssignments[k];
    });

    const tempStats = {};
    staffList.forEach(s => tempStats[s.id] = 0);

    days.forEach(day => {
        const dateKey = formatDateKey(year, month, day);
        const dayAssignments = {};
        const usedStaffIds = new Set();

        DUTY_SLOTS.forEach(slot => {
            let candidates = [];
            if (slot.type === '24') {
                candidates = staffList.filter(s => s.group === 'A' && !usedStaffIds.has(s.id));
            } else {
                candidates = staffList.filter(s => !usedStaffIds.has(s.id));
            }

            if (candidates.length > 0) {
                candidates.sort((a, b) => tempStats[a.id] - tempStats[b.id]);
                
                const poolSize = Math.min(candidates.length, 6);
                const chosenIndex = Math.floor(Math.random() * poolSize);
                const chosenStaff = candidates[chosenIndex];

                dayAssignments[slot.id] = chosenStaff.id;
                usedStaffIds.add(chosenStaff.id);
                tempStats[chosenStaff.id] += 1;
            }
        });
        newAssignments[dateKey] = dayAssignments;
    });

    setAssignments(newAssignments);
    setViewMode('matrix');
    showNotification("Otomatik planlama tamamlandı!", "success");
    setShowAutoFillConfirm(false);
  };

  const autoFillDay = () => {
    if (!selectedDay) return;
    const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);
    
    const currentDayAssignments = { ...assignments[dateKey] } || {};
    const usedStaffIds = new Set(Object.values(currentDayAssignments).map(id => parseInt(id)));

    const availableStaffA = staffList.filter(s => s.group === 'A' && !usedStaffIds.has(s.id));
    const availableStaffB = staffList.filter(s => s.group === 'B' && !usedStaffIds.has(s.id));
    
    const shuffle = (array) => array.sort(() => Math.random() - 0.5);
    let poolA = shuffle([...availableStaffA]);
    let poolB = shuffle([...availableStaffB]);
    
    const newAssignments = { ...currentDayAssignments };

    DUTY_SLOTS.forEach(slot => {
        if (!newAssignments[slot.id]) {
            let candidate = null;
            if (slot.type === '24') {
                if (poolA.length > 0) candidate = poolA.pop();
            } else {
                if (poolB.length > 0) { candidate = poolB.pop(); }
                else if (poolA.length > 0) { candidate = poolA.pop(); }
            }
            if (candidate) {
                newAssignments[slot.id] = candidate.id;
                usedStaffIds.add(candidate.id);
            }
        }
    });

    setAssignments(prev => ({ ...prev, [dateKey]: newAssignments }));
  };

  const clearDay = () => {
      if(!selectedDay) return;
      const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);
      const newAssignments = { ...assignments };
      delete newAssignments[dateKey];
      setAssignments(newAssignments);
  }

  // --- ÇIKTI VE İNDİRME İŞLEMLERİ ---

  const printDocument = () => {
    window.print();
  };

  // Dinamik script yükleme ile JPG alma (Çevrimdışı uyumlu hale getirmek için CDN fallback)
  const downloadAsJpg = async () => {
      showNotification("JPG hazırlanıyor...", "info");
      
      // html2canvas kütüphanesini dinamik olarak yükle
      if (!window.html2canvas) {
          try {
              const script = document.createElement('script');
              script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
              script.onload = () => captureJpg();
              script.onerror = () => showNotification("İnternet bağlantısı gerekli (JPG için).", "error");
              document.body.appendChild(script);
          } catch (e) {
              showNotification("Kütüphane yüklenemedi.", "error");
          }
      } else {
          captureJpg();
      }
  };

  const captureJpg = () => {
      if (!matrixRef.current || !window.html2canvas) return;
      window.html2canvas(matrixRef.current, { scale: 2 }).then(canvas => {
          const image = canvas.toDataURL("image/jpeg", 1.0);
          const link = document.createElement("a");
          link.href = image;
          link.download = `Nobet_Listesi_${MONTHS[currentDate.getMonth()]}_${currentDate.getFullYear()}.jpg`;
          link.click();
          showNotification("JPG İndirildi.", "success");
      }).catch(err => {
          console.error(err);
          showNotification("Görüntü oluşturulamadı.", "error");
      });
  };

  // --- RENDER ---

  const renderModal = () => {
    if (!selectedDay) return null;
    const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);
    const dayData = assignments[dateKey] || {};

    const assignedCount = Object.keys(dayData).length;
    const isFull = assignedCount === 18;

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 md:p-4 overflow-y-auto no-print">
        <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
          <div className="p-4 md:p-6 border-b bg-white z-10 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
              <h2 className="text-xl md:text-2xl font-bold text-gray-800">
                {selectedDay} {MONTHS[currentDate.getMonth()]} - Planlama
              </h2>
              <p className={`text-sm font-medium ${isFull ? 'text-green-600' : 'text-orange-500'}`}>
                Doluluk: {assignedCount} / 18 Personel
              </p>
            </div>
            <div className="flex flex-wrap gap-2 justify-center">
                <button onClick={autoFillDay} className="px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm font-medium flex-1 md:flex-none whitespace-nowrap">
                    Bugünü Doldur
                </button>
                <button onClick={clearDay} className="px-3 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm font-medium flex-1 md:flex-none">
                    Temizle
                </button>
                <button onClick={() => setSelectedDay(null)} className="p-2 hover:bg-gray-100 rounded-full">
                <X size={24} />
                </button>
            </div>
          </div>

          <div className="p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto">
            {DUTY_SLOTS.map(slot => {
              const assignedStaffId = dayData[slot.id];
              const slotColor = slot.type === '24' ? 'bg-blue-50 border-blue-200' : slot.type === '16' ? 'bg-orange-50 border-orange-200' : 'bg-green-50 border-green-200';
              const typeBadge = slot.type === '24' ? 'bg-blue-600' : slot.type === '16' ? 'bg-orange-500' : 'bg-green-600';

              return (
                <div key={slot.id} className={`p-3 rounded-lg border ${slotColor} shadow-sm`}>
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-semibold text-gray-700 text-sm">{slot.label}</span>
                    <span className={`${typeBadge} text-white text-xs px-2 py-0.5 rounded-full`}>{slot.type} Saat</span>
                  </div>
                  
                  <select 
                    className="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-blue-500 text-sm"
                    value={assignedStaffId || ""}
                    onChange={(e) => handleAssignment(slot.id, e.target.value)}
                  >
                    <option value="">-- Seçiniz --</option>
                    {staffList
                        .filter(s => slot.type === '24' ? s.group === 'A' : true) 
                        .sort((a,b) => a.name.localeCompare(b.name))
                        .map(staff => {
                            const staffStats = stats[staff.id];
                            return (
                                <option key={staff.id} value={staff.id}>
                                    {staff.name} ({staffStats.hours}s) {staff.group === 'B' ? '(B)' : ''}
                                </option>
                            )
                        })
                    }
                  </select>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  };

  const renderMatrix = () => {
    const days = getDaysInMonth(currentDate);

    return (
      <div className="overflow-x-auto bg-white shadow-lg rounded-lg p-2 md:p-4" ref={matrixRef}>
        <div className="mb-4 text-center hidden print:block">
            <h1 className="text-xl font-bold text-gray-900">ERİŞKİN ACİL SERVİS NÖBET ÇİZELGESİ</h1>
            <h2 className="text-lg text-gray-700">{MONTHS[currentDate.getMonth()]} {currentDate.getFullYear()}</h2>
        </div>

        <table className="min-w-full border-collapse text-xs md:text-sm">
          <thead>
            <tr>
              <th className="border p-1 md:p-2 bg-gray-100 text-left sticky left-0 z-20 w-32 md:w-48 min-w-[120px]">Personel</th>
              <th className="border p-1 md:p-2 bg-gray-100 text-center w-8 md:w-12">Top.</th>
              {days.map(d => (
                <th key={d} className={`border p-0.5 md:p-1 bg-gray-50 text-center min-w-[24px] md:min-w-[28px] ${[0,6].includes(new Date(currentDate.getFullYear(), currentDate.getMonth(), d-1).getDay()) ? 'bg-red-50 text-red-600' : ''}`}>
                  <div className="font-bold">{d}</div>
                  <div className="text-[9px] md:text-[10px] font-normal text-gray-500 hidden md:block">{getDayName(d)}</div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {staffList.sort((a,b) => a.name.localeCompare(b.name)).map(staff => {
              const staffStats = stats[staff.id];
              return (
                <tr key={staff.id} className="hover:bg-gray-50">
                  <td className="border p-1 pl-2 font-medium sticky left-0 bg-white z-10 truncate border-r-2 text-[10px] md:text-xs">
                    {staff.name} 
                    {staff.group === 'B' && <span className="text-[9px] ml-1 text-purple-600 hidden md:inline">(B)</span>}
                  </td>
                  <td className="border p-1 text-center font-bold bg-blue-50 text-[10px] md:text-xs">{staffStats.hours}</td>
                  {days.map(d => {
                    const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), d);
                    const dayData = assignments[dateKey] || {};
                    const slotId = Object.keys(dayData).find(key => dayData[key] == staff.id);
                    const slot = slotId ? DUTY_SLOTS.find(s => s.id === slotId) : null;

                    let cellContent = "";
                    let cellClass = "";

                    if (slot) {
                        cellContent = slot.type;
                        if(slot.type === '24') cellClass = "bg-blue-100 text-blue-800 font-bold print:bg-gray-200 print:text-black";
                        else if(slot.type === '16') cellClass = "bg-orange-100 text-orange-800 font-bold print:bg-gray-100 print:text-black";
                        else if(slot.type === '8') cellClass = "bg-green-100 text-green-800 font-bold print:border-black";
                    }

                    return (
                      <td key={d} className={`border p-0.5 text-center text-[9px] md:text-[10px] ${cellClass}`}>
                        {cellContent}
                      </td>
                    );
                  })}
                </tr>
              );
            })}
          </tbody>
        </table>
        
        {/* Footer for Print & JPG */}
        <div className="mt-8 grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 text-[10px] print:grid-cols-4 print:mt-4">
             <div className="border p-2">
                <h4 className="font-bold border-b mb-1">24 Saatlik</h4>
                <p>Sarı: 4 | Kadın: 3</p>
                <p>Erkek: 3 | Triaj: 2</p>
                <p>Yeşil: 2</p>
             </div>
             <div className="border p-2">
                <h4 className="font-bold border-b mb-1">Kısa Nöbet</h4>
                <p>Triaj (8s): 1 | (16s): 1</p>
                <p>Yeşil (8s): 1 | (16s): 1</p>
             </div>
             <div className="border p-2">
                 <h4 className="font-bold border-b mb-1">Kodlar</h4>
                 <div className="flex items-center gap-2 mb-1">24: Tam Gün</div>
                 <div className="flex items-center gap-2 mb-1">16: 16 Saat</div>
                 <div className="flex items-center gap-2 mb-1">8: 8 Saat</div>
             </div>
             <div className="border p-2">
                 <h4 className="font-bold border-b mb-1">Onay</h4>
                 <p className="mt-4 border-t pt-2">Başhekim / Onay</p>
             </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800 relative">
      {/* NOTIFICATION TOAST */}
      {notification && (
          <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] px-4 md:px-6 py-3 rounded-full shadow-xl text-white font-medium flex items-center gap-2 animate-bounce text-sm md:text-base whitespace-nowrap ${notification.type === 'error' ? 'bg-red-600' : 'bg-green-600'}`}>
              {notification.type === 'error' ? <AlertCircle size={20}/> : <Check size={20}/>}
              {notification.message}
          </div>
      )}

      {/* AUTO FILL CONFIRM MODAL */}
      {showAutoFillConfirm && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] no-print p-4">
              <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                  <h3 className="text-xl font-bold text-gray-900 mb-2 flex items-center gap-2"><AlertTriangle className="text-orange-500" /> Dikkat</h3>
                  <p className="text-gray-600 mb-6">
                      Tüm ay için otomatik planlama yapılacak. Mevcut ayın tüm verileri silinip yeniden oluşturulacak.
                  </p>
                  <div className="flex justify-end gap-3 flex-col md:flex-row">
                      <button onClick={() => setShowAutoFillConfirm(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">İptal</button>
                      <button onClick={autoFillMonth} className="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded shadow">Evet, Planla</button>
                  </div>
              </div>
          </div>
      )}

      {/* HEADER */}
      <header className="bg-teal-700 text-white p-4 shadow-md no-print">
        <div className="container mx-auto">
            <div className="flex justify-between items-center">
                <div className="flex items-center gap-3">
                    <Calendar size={28} />
                    <div>
                    <h1 className="text-xl md:text-2xl font-bold">Nöbet Planlama</h1>
                    <p className="text-teal-200 text-xs md:text-sm">Hastane Acil Servis</p>
                    </div>
                </div>

                {/* Mobile Menu Toggle */}
                <button className="md:hidden p-2" onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}>
                    {isMobileMenuOpen ? <X size={24} /> : <Menu size={24} />}
                </button>

                {/* Desktop Nav */}
                <div className="hidden md:flex gap-2">
                    <button onClick={() => setViewMode('calendar')} className={`px-3 py-2 rounded flex items-center gap-2 ${viewMode === 'calendar' ? 'bg-white text-teal-800' : 'hover:bg-teal-600'}`}>
                        <Calendar size={18} /> Takvim
                    </button>
                    <button onClick={() => setViewMode('matrix')} className={`px-3 py-2 rounded flex items-center gap-2 ${viewMode === 'matrix' ? 'bg-white text-teal-800' : 'hover:bg-teal-600'}`}>
                        <FileSpreadsheet size={18} /> Çizelge
                    </button>
                    <button onClick={() => setViewMode('staff')} className={`px-3 py-2 rounded flex items-center gap-2 ${viewMode === 'staff' ? 'bg-white text-teal-800' : 'hover:bg-teal-600'}`}>
                        <Users size={18} /> Personel
                    </button>
                </div>
            </div>

            {/* Mobile Nav */}
            {isMobileMenuOpen && (
                <div className="flex flex-col gap-2 mt-4 md:hidden pb-2 border-t border-teal-600 pt-2">
                     <div className="flex items-center justify-between bg-teal-800 p-2 rounded-lg mb-2">
                        <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-teal-600 rounded"><ChevronLeft /></button>
                        <span className="font-bold text-lg">
                        {MONTHS[currentDate.getMonth()]} {currentDate.getFullYear()}
                        </span>
                        <button onClick={() => changeMonth(1)} className="p-1 hover:bg-teal-600 rounded"><ChevronRight /></button>
                    </div>
                    <button onClick={() => { setViewMode('calendar'); setIsMobileMenuOpen(false); }} className={`p-3 rounded text-left ${viewMode === 'calendar' ? 'bg-white text-teal-800' : 'hover:bg-teal-600'}`}>Takvim</button>
                    <button onClick={() => { setViewMode('matrix'); setIsMobileMenuOpen(false); }} className={`p-3 rounded text-left ${viewMode === 'matrix' ? 'bg-white text-teal-800' : 'hover:bg-teal-600'}`}>Çizelge</button>
                    <button onClick={() => { setViewMode('staff'); setIsMobileMenuOpen(false); }} className={`p-3 rounded text-left ${viewMode === 'staff' ? 'bg-white text-teal-800' : 'hover:bg-teal-600'}`}>Personel</button>
                </div>
            )}

            {/* Desktop Month Selector (Hidden on mobile inside menu above) */}
            <div className="hidden md:flex items-center justify-center gap-4 mt-2">
                 <div className="flex items-center gap-4 bg-teal-800 p-1 px-4 rounded-full text-sm">
                    <button onClick={() => changeMonth(-1)} className="hover:text-teal-300"><ChevronLeft size={20}/></button>
                    <span className="font-bold min-w-[100px] text-center">
                    {MONTHS[currentDate.getMonth()]} {currentDate.getFullYear()}
                    </span>
                    <button onClick={() => changeMonth(1)} className="hover:text-teal-300"><ChevronRight size={20}/></button>
                </div>
            </div>
        </div>
      </header>

      {/* MAIN CONTENT */}
      <main className="container mx-auto p-2 md:p-4">
        
        {/* Toolbar */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3 no-print">
             <div className="w-full md:w-auto">
                {viewMode === 'matrix' && (
                    <button onClick={() => setShowAutoFillConfirm(true)} className="w-full md:w-auto bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 flex items-center justify-center gap-2">
                        <Sparkles size={18} /> Otomatik Planla
                    </button>
                )}
             </div>
            {viewMode === 'matrix' && (
                <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                    <button onClick={downloadAsJpg} className="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 flex items-center justify-center gap-2">
                        <ImageIcon size={18} /> JPG Kaydet
                    </button>
                    <button onClick={printDocument} className="bg-gray-700 text-white px-4 py-2 rounded shadow hover:bg-gray-800 flex items-center justify-center gap-2">
                        <Printer size={18} /> Yazdır
                    </button>
                    <button onClick={printDocument} className="bg-red-600 text-white px-4 py-2 rounded shadow hover:bg-red-700 flex items-center justify-center gap-2" title="Yazıcı hedefi olarak PDF seçin">
                        <FileText size={18} /> PDF Olarak Kaydet
                    </button>
                </div>
            )}
        </div>

        {/* VIEW: CALENDAR */}
        {viewMode === 'calendar' && (
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-1 md:gap-2">
                {['Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'].map(day => (
                    <div key={day} className="text-center font-bold text-gray-500 py-2 text-sm">{day}</div>
                ))}
                
                {Array.from({ length: (new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay() + 6) % 7 }).map((_, i) => (
                    <div key={`empty-${i}`} className="bg-transparent h-20 md:h-32"></div>
                ))}

                {getDaysInMonth(currentDate).map(day => {
                    const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const dayAssignments = assignments[dateKey] || {};
                    const count = Object.keys(dayAssignments).length;
                    const isFull = count === 18;
                    const isWeekend = [0, 6].includes(new Date(currentDate.getFullYear(), currentDate.getMonth(), day - 1).getDay());

                    return (
                        <div 
                            key={day} 
                            onClick={() => setSelectedDay(day)}
                            className={`
                                h-24 md:h-32 border rounded-lg p-1 md:p-2 cursor-pointer transition-all hover:shadow-md
                                ${isWeekend ? 'bg-gray-50' : 'bg-white'}
                                ${isFull ? 'border-green-300' : count > 0 ? 'border-orange-300' : 'border-gray-200'}
                            `}
                        >
                            <div className="flex justify-between items-start">
                                <span className={`text-base md:text-lg font-bold ${isWeekend ? 'text-red-500' : 'text-gray-700'}`}>{day}</span>
                                {count > 0 && (
                                    <span className={`text-[10px] md:text-xs px-1.5 py-0.5 rounded-full ${isFull ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>
                                        {count}/18
                                    </span>
                                )}
                            </div>
                            
                            <div className="mt-1 md:mt-2 space-y-1 text-[10px] md:text-xs text-gray-500">
                                {count === 0 ? (
                                    <div className="h-full flex items-center justify-center text-gray-300 pt-2">
                                        <Plus size={20} />
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex justify-between"><span>24s:</span> <b>{Object.keys(dayAssignments).filter(k => DUTY_SLOTS.find(s=>s.id===k).type === '24').length}/14</b></div>
                                        <div className="flex justify-between"><span>Kısa:</span> <b>{Object.keys(dayAssignments).filter(k => DUTY_SLOTS.find(s=>s.id===k).type !== '24').length}/4</b></div>
                                    </>
                                )}
                            </div>
                        </div>
                    );
                })}
            </div>
        )}

        {/* VIEW: MATRIX */}
        {viewMode === 'matrix' && renderMatrix()}

        {/* VIEW: STAFF */}
        {viewMode === 'staff' && (
            <StaffManager 
                staffList={staffList} 
                setStaffList={setStaffList} 
                showNotification={showNotification}
            />
        )}

      </main>

      {/* MODALS */}
      {renderModal()}

      {/* PRINT STYLES */}
      <style>{`
        @media print {
            @page {
                size: landscape;
                margin: 5mm;
            }
            .no-print {
                display: none !important;
            }
            body {
                background: white;
            }
            main {
                margin: 0;
                padding: 0;
                width: 100%;
            }
            .overflow-x-auto {
                overflow: visible !important;
                box-shadow: none !important;
            }
            table {
                width: 100% !important;
                border-collapse: collapse;
                font-size: 8px !important;
            }
            th, td {
                border: 1px solid #000 !important;
                padding: 1px !important;
                color: black !important;
            }
            .sticky {
                position: static !important;
            }
            .bg-blue-100, .bg-orange-100, .bg-green-100 {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            /* Mobilde gizlenen bazı şeyler baskıda çıksın */
            .hidden.md\\:block {
                display: block !important;
            }
        }
      `}</style>
    </div>
  );
}
